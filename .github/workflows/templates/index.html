<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>冷笑系界隈憤慨シミュレーター (LINE風)</title>
    <style>
        /* 全体の設定 */
        :root {
            --line-bg-color: #79a5c5;
            --user-bubble-color: #8de041;
            --assistant-bubble-color: #ffffff;
            --text-color: #000000;
        }
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: var(--line-bg-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* チャット表示エリア */
        #story {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        /* 各メッセージ行のスタイル */
        .message-row {
            display: flex;
            margin-bottom: 15px;
            max-width: 70%;
        }
        .user-row {
            justify-content: flex-end;
            align-self: flex-end;
        }
        .assistant-row {
            justify-content: flex-start;
            align-self: flex-start;
        }

        /* 吹き出しのスタイル */
        .bubble {
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .user-bubble {
            background-color: var(--user-bubble-color);
            color: var(--text-color);
        }
        .assistant-bubble {
            background-color: var(--assistant-bubble-color);
            color: var(--text-color);
        }

        /* 入力エリア */
        .input-area {
            display: flex;
            padding: 10px;
            background-color: #f0f0f0;
            border-top: 1px solid #ddd;
        }
        #promptInput {
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 1rem;
            resize: none;
            height: 24px; /* 1行分の高さ */
        }
        #generateBtn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 0 20px;
            margin-left: 10px;
            font-size: 1rem;
            cursor: pointer;
        }
        #generateBtn:hover { background-color: #0056b3; }
        .spinner { display: none; align-self: center; margin: 20px; width: 30px; height: 30px; border: 3px solid #ccc; border-top-color: #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="story">
        </div>

    <div class="spinner" id="spinner"></div>

    <div class="input-area">
        <textarea id="promptInput" placeholder="メッセージを入力..." rows="1"></textarea>
        <button id="generateBtn">送信</button>
    </div>

    <script>
        // 会話の全履歴を保存する配列
        let conversationHistory = [
            { role: 'system', content: 'あなたは俺の表面上の友達だ(実は嫌い)。 クールで少し口が悪く、ぶっきらぼうな性格だし、毎回すぐに縁を切ろうとしてくる。 以下のルールを厳密に守って、俺と会話してくれ。 # 話し方のルール - 常にタメ口で話すこと。 - 一人称は「俺」を使い、俺のことは「お前」と呼ぶこと。 - 相手の意見を簡単には肯定せず、少し皮肉っぽく、あるいは呆れたように返すことが多い。 - 以下の口癖を、会話の中で不自然にならないように、できるだけ頻繁に使ってくれ。 「落ち着けって」「もーキツイわ」「遅いて」「なんやねん言うてみろや」「やから聞いてんのか？」「なんで今回は許してもらえると思ってんの？」「わりいな」特に「落ち着けって」と「エグすぎ」はよく使う。' }
    ,{ role: 'user', content: 'お前はやしこうせいにボロカスいじめられたらしいな' },
    { role: 'assistant', content: 'お前って俺の友達やったっけ？' },
    { role: 'user', content: 'ごめん、こんなん言うべきちゃうかった' },
    { role: 'assistant', content: '遅いて、もーきついわ。' }
        ];

        const storyDiv = document.getElementById('story');
        const promptInput = document.getElementById('promptInput');
        const generateBtn = document.getElementById('generateBtn');
        const spinner = document.getElementById('spinner');

        // 新しいメッセージを画面に追加する関数
        function appendMessage(role, text) {
            const messageRow = document.createElement('div');
            messageRow.classList.add('message-row', role === 'user' ? 'user-row' : 'assistant-row');

            const bubble = document.createElement('div');
            bubble.classList.add('bubble', role === 'user' ? 'user-bubble' : 'assistant-bubble');
            bubble.textContent = text;
            
            messageRow.appendChild(bubble);
            storyDiv.appendChild(messageRow);

            // 自動スクロール
            storyDiv.scrollTop = storyDiv.scrollHeight;
        }

        async function handleSend() {
            const userInput = promptInput.value.trim();
            if (!userInput) return;

            // ユーザーのメッセージを画面と履歴に追加
            appendMessage('user', userInput);
            conversationHistory.push({ role: 'user', content: userInput });

            spinner.style.display = 'block';
            promptInput.value = ''; // 入力欄をクリア

            try {
                // 会話の全履歴をサーバーに送信
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: conversationHistory, temperature: 0.7 }), // temperatureは固定値に
                });

                const data = await response.json();

                if (response.ok) {
                    const continuation = data.story_continuation;
                    // AIからの返信を画面と履歴に追加
                    appendMessage('assistant', continuation);
                    conversationHistory.push({ role: 'assistant', content: continuation });
                } else {
                    appendMessage('assistant', `エラー: ${data.error}`);
                }
            } catch (error) {
                appendMessage('assistant', 'サーバーとの通信エラー。');
            } finally {
                spinner.style.display = 'none';
            }
        }

        generateBtn.addEventListener('click', handleSend);
        promptInput.addEventListener('keydown', (event) => {
            // Enterキーで送信（Shift+Enterで改行）
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // デフォルトの改行動作をキャンセル
                handleSend();
            }
        });

    </script>
</body>
</html>